<?xml version="1.0" encoding="UTF-8"?>
<beans:beans xmlns="http://www.springframework.org/schema/integration"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:beans="http://www.springframework.org/schema/beans"
             xmlns:int-xml="http://www.springframework.org/schema/integration/xml"
             xmlns:jms="http://www.springframework.org/schema/integration/jms"
             xmlns:file="http://www.springframework.org/schema/integration/file"
             xsi:schemaLocation="
             http://www.springframework.org/schema/beans
             http://www.springframework.org/schema/beans/spring-beans.xsd
             http://www.springframework.org/schema/integration
             http://www.springframework.org/schema/integration/spring-integration.xsd
             http://www.springframework.org/schema/integration/xml
             http://www.springframework.org/schema/integration/xml/spring-integration-xml.xsd
             http://www.springframework.org/schema/integration/jms
             http://www.springframework.org/schema/integration/jms/spring-integration-jms.xsd
             http://www.springframework.org/schema/integration/file
             http://www.springframework.org/schema/integration/file/spring-integration-file.xsd">

  <!-- Зависимости конфигурации (используемые бины) -->
  <beans:bean class="mis.integration.ariadna.config.IntegrationConfig"/>
  <beans:import resource="logger-integration.xml"/>

  <!--TODO Временное решение для отладки, в боевом режиме цепляемся к jms -->
  <file:inbound-channel-adapter id="lisRequestFileInput"
                                directory="file:${input.request.directory}"
                                channel="misPrescriptionFileChannel">
    <poller fixed-delay="50"/>
  </file:inbound-channel-adapter>
  <channel id="misPrescriptionFileChannel"/>
  <file:file-to-string-transformer input-channel="misPrescriptionFileChannel" output-channel="misPrescriptionStringChannel"
                                   delete-files="true"/>

  <!-- Преобразование "Заявки на ЛИ", поступившей из МИС -->

  <channel id="misPrescriptionStringChannel" datatype="java.lang.String">
    <interceptors>
      <wire-tap channel="loggerChannel"/>
    </interceptors>
  </channel>

  <chain input-channel="misPrescriptionStringChannel" output-channel="observationStringChannel">
    <int-xml:unmarshalling-transformer unmarshaller="misPrescriptionMarshaller"/>
    <transformer ref="ariadnaTransformerBean" method="transformToObservation"/>
    <int-xml:marshalling-transformer marshaller="ariadnaJaxb2Marshaller" result-type="StringResult"/>
    <transformer expression="payload.toString()"/>
  </chain>

  <publish-subscribe-channel id="observationStringChannel" datatype="java.lang.String">
    <interceptors>
      <wire-tap channel="loggerChannel"/>
    </interceptors>
  </publish-subscribe-channel>

  <file:outbound-channel-adapter
      channel="observationStringChannel"
      filename-generator="xmlReportFileGenerator"
      directory="file:${output.request.directory}"/>

  <!--TODO md5Transformer -->

  <file:outbound-channel-adapter
      channel="observationStringChannel"
      filename-generator="md5ReportFileGenerator"
      directory="file:${output.request.directory}"/>

</beans:beans>